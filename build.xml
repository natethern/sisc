<project name="sisc" default="all">

  <path id="classpath">
    <fileset dir="./lib">
      <include name="*.jar"/>
    </fileset>
    <pathelement path=".."/>
  </path>

  <target name="prepare">
    <property name="version" value="1.4.0rc2"/>
    <property file="${basedir}/build.properties"/>    
    <property name="srcdir" value="${basedir}/.."/>
    <property name="classdir" value="${basedir}/classes"/>
    <property name="libdir" value="${basedir}/lib"/>
    <property name="docdir" value="${basedir}/doc"/>
    <property name="gendocdir" value="${docdir}/generated"/>
    <property name="schemedir" value="${basedir}/scheme-src"/>
    <property name="packagename" value="sisc"/>
    <property name="jarname" value="sisc.jar"/>
    <property name="heap" value="${basedir}/boot/sisc.heap"/>
    <property name="quantity-type" value="apfloat"/>
    <property name="debugging" value="on"/>
    <property name="optimization" value="on"/>
    <property name="releasecandidate" value="yes"/>
    <property name="dist" value="${basedir}/dist"/>
    <property name="doc.style" value="/usr/share/sgml/docbook/stylesheet/xsl/nwalsh/html/docbook.xsl"/>
    <mkdir dir="${libdir}"/>
    <available classname="junit.framework.TestCase"
               property="junit.present"
	       classpathref="classpath"/>
  </target>

  <target name="clean" depends="prepare"
          description="Remove generated sources, class files and jar files">
    <delete dir="${classdir}"/>
    <delete dir="${gendocdir}"/>
    <delete file="${docdir}/sss/style.xsl"/>
    <delete file="${basedir}/${jarname}"/>
    <delete file="${heap}"/>
    <delete file="${basedir}/data/Quantity.java"/>
    <delete file="${basedir}/Conf.java"/>
  </target> 

  <target name="select-full-config" depends="prepare" unless="lite">
    <copy file="${basedir}/Conf-full.java.tmpl"
          tofile="${basedir}/Conf.java"
          overwrite="yes"/>
  </target>

  <target name="select-lite-config" depends="prepare" if="lite">
    <copy file="${basedir}/Conf-lite.java.tmpl"
          tofile="${basedir}/Conf.java"
          overwrite="yes"/>
  </target>

  <target name="select-config" depends="select-full-config,select-lite-config">
  </target>

  <target name="compiler" depends="select-config">
    <copy file="${basedir}/data/Quantity-${quantity-type}.java.tmpl"
          tofile="${basedir}/data/Quantity.java"
          overwrite="yes"/>
    <mkdir dir="${classdir}"/>
    <javac srcdir="${srcdir}"
           destdir="${classdir}"
           classpathref="classpath"
           debug="${debugging}"
           optimize="${optimization}">
      <include name="${packagename}/**"/>
      <exclude name="${packagename}/dist/**"/>
      <exclude name="${packagename}/tests/**" unless="junit.present"/>
      <exclude name="${packagename}/modules/**" if="lite"/>
      <exclude name="${packagename}/applet/**"/>
    </javac>      
  </target>
  
  <target name="i18n" depends="prepare">
    <copy todir="${classdir}">
      <fileset dir="${basedir}/i18n" >
        <include name="**/*.properties"/>
      </fileset>                   
    </copy>
  </target> 

  <target name="jars" depends="compiler,i18n">
    <jar jarfile="${basedir}/${jarname}"
	 manifest="${basedir}/boot/Manifest">
      <fileset dir="${classdir}">
	<include name="*/**"/>
	<exclude name="sisc/boot/GenerateHeap.class" if="lite"/>
      </fileset>
    </jar>
  </target>
  
  <target name="full-heap" depends="jars" unless="lite">
    <java classname="sisc.boot.GenerateHeap"
          classpath="${classdir}"
          dir="${schemedir}"
	  fork="yes">
      <arg value="-out"/>
      <arg value="${heap}"/>
      <arg value="-files"/>
      <arg value="${schemedir}/init.pp"/>
      <arg value="${schemedir}/compat.pp"/>
      <arg value="${schemedir}/psyntax.pp"/>
      <arg value="${schemedir}/init2.scm"/>
      <arg value="${schemedir}/pp.scm"/>
      <arg value="${schemedir}/repl.scm"/>
      <arg value="${schemedir}/debug.scm"/>
    </java>
  </target>

  <target name="lite-heap" depends="jars" if="lite">
    <java classname="sisc.boot.GenerateHeap"
          classpath="${classdir}"
          dir="${schemedir}"
	  fork="yes">
      <arg value="-out"/>
      <arg value="${heap}"/>
      <arg value="-files"/>
      <arg value="${schemedir}/lite.scm"/>
      <arg value="${schemedir}/init.pp"/>
      <arg value="${schemedir}/compat.pp"/>
      <arg value="${schemedir}/psyntax.pp"/>
      <arg value="${schemedir}/init2.scm"/>
      <arg value="${schemedir}/pp.scm"/>
      <arg value="${schemedir}/repl.scm"/>
    </java>
  </target>

  <target name="heap" depends="full-heap,lite-heap">
  </target>

  <target name="javadocs" depends="prepare"
          description="Generate javadocs">
    <mkdir dir="${gendocdir}/javadoc"/>
    <javadoc packagenames="${packagename}.*"
	     sourcepath="${srcdir}"
	     destdir="${gendocdir}/javadoc"/>
  </target>

  <target name="manual" depends="prepare"
          description="Generate Manual">
    <copy file="${docdir}/sss/html.xsl" tofile="${docdir}/sss/style.xsl"/>
    <replace file="${docdir}/sss/style.xsl"
             token="@@@doc.style@@@"
             value="${doc.style}"/>
    <mkdir dir="${gendocdir}/sss"/>
    <style basedir="${docdir}/sss"
           includes="sss.xml"
           destdir="${gendocdir}/sss"
           style="${docdir}/sss/style.xsl">
    </style>
    <copy file="${docdir}/sss/sss.css" tofile="${gendocdir}/sss/sss.css"/>
  </target>

  <target name="docs" depends="javadocs,manual"
          description="Generate Documentation"/>

  <target name="all" depends="heap,docs"
          description="Build lite edition">
  </target>

  <target name="lite-dist" depends="clean,all" if="lite">
    <delete dir="${dist}/lite"/>
    <mkdir dir="${dist}/lite"/>
    <mkdir dir="${dist}/lite/win"/>
    <mkdir dir="${dist}/lite/unix"/>
    <mkdir dir="${dist}/lite/win/sisc"/>
    <mkdir dir="${dist}/lite/unix/sisc"/>

    <copy todir="${dist}/lite/win/sisc"
          file="${basedir}/${jarname}"/>
    <copy todir="${dist}/lite/unix/sisc"
          file="${basedir}/${jarname}"/>
    <copy todir="${dist}/lite/win/sisc"
          file="${heap}"/>
    <copy todir="${dist}/lite/unix/sisc"
          file="${heap}"/>
    <copy todir="${dist}/lite/win/sisc">
      <fileset dir="${dist}">
	<include name="ChangeLog"/>
	<include name="README"/>
	<include name="COPYING"/>
        <include name="ReleaseCandidate" if="releasecandidate"/>
	<include name="sisc.bat"/>
      </fileset>
    </copy>
    <copy todir="${dist}/lite/unix/sisc">
      <fileset dir="${dist}">
	<include name="ChangeLog"/>
	<include name="README"/>
        <include name="ReleaseCandidate" if="releasecandidate"/>
	<include name="COPYING"/>
      </fileset>
    </copy>

    <copy file="${dist}/sisc.sh"
          tofile="${dist}/lite/unix/sisc/sisc"/>
    <chmod file="${dist}/lite/unix/sisc/sisc"
           perm="ugo+rx"/>

    <tar tarfile="${dist}/sisc-lite-${version}.tar">

      <tarfileset dir="${dist}/lite/unix" mode="755">
	<include name="sisc/sisc"/>
      </tarfileset>
      <tarfileset dir="${dist}/lite/unix">
	<include name="sisc/*"/>
	<exclude name="sisc/sisc"/>
      </tarfileset>
    </tar>

    <gzip src="${dist}/sisc-lite-${version}.tar"
          zipfile="${dist}/sisc-lite-${version}.tar.gz" />
    <delete file="${dist}/sisc-lite-${version}.tar"/>
    <zip zipfile="${dist}/sisc-lite-${version}.zip"
         basedir="${dist}/lite/win"/>

  </target>

  <target name="full-dist" depends="clean,all" unless="lite">
    <delete dir="${dist}/full"/>
    <mkdir dir="${dist}/full"/>
    <mkdir dir="${dist}/full/win"/>
    <mkdir dir="${dist}/full/unix"/>
    <mkdir dir="${dist}/full/win/sisc"/>
    <mkdir dir="${dist}/full/unix/sisc"/>

    <copy todir="${dist}/full/win/sisc"
          file="${basedir}/${jarname}"/>
    <copy todir="${dist}/full/unix/sisc"
          file="${basedir}/${jarname}"/>
    <copy todir="${dist}/full/win/sisc"
          file="${heap}"/>
    <copy todir="${dist}/full/unix/sisc"
          file="${heap}"/>
    <copy todir="${dist}/full/win/sisc">
      <fileset dir="${dist}">
	<include name="ChangeLog"/>
        <include name="ReleaseCandidate" if="releasecandidate"/>
	<include name="README"/>
	<include name="COPYING"/>
	<include name="sisc.bat"/>
      </fileset>
    </copy>
    <copy todir="${dist}/full/unix/sisc">
      <fileset dir="${dist}">
	<include name="ChangeLog"/>
	<include name="README"/>
	<include name="COPYING"/>
        <include name="ReleaseCandidate" if="releasecandidate"/>
      </fileset>
    </copy>

    <copy file="${dist}/sisc.sh"
          tofile="${dist}/full/unix/sisc/sisc"/>
    <chmod file="${dist}/full/unix/sisc/sisc"
           perm="ugo+rx"/>

    <tar tarfile="${dist}/sisc-${version}.tar">

      <tarfileset dir="${dist}/full/unix" mode="755">
	<include name="sisc/sisc"/>
      </tarfileset>
      <tarfileset dir="${dist}/full/unix">
	<include name="sisc/*"/>
	<exclude name="sisc/sisc"/>
      </tarfileset>
    </tar>

    <gzip src="${dist}/sisc-${version}.tar"
          zipfile="${dist}/sisc-${version}.tar.gz" />
    <delete file="${dist}/sisc-${version}.tar"/>
    <zip zipfile="${dist}/sisc-${version}.zip"
         basedir="${dist}/full/win"/>
  </target>

  <target name="dist" depends="full-dist,lite-dist">
  </target>

  <target name="source-dist" depends="prepare">
    <delete dir="${dist}/sisc"/>
    <cvs command="export" dest="${dist}" date="NOW" package="sisc"/>
    <jar jarfile="${dist}/sisc-${version}.jar" 
         basedir="${dist}"  
         includes="sisc/**"/>
  </target>

  <target name="applet" depends="all">
    <javac srcdir="${srcdir}"
           destdir="${classdir}"
	   classpathref="classpath"
	   debug="${debugging}"
           optimize="${optimization}">
      <include name="${packagename}/applet/**"/>
    </javac>
    <jar jarfile="${dist}/sisc-applet.jar"
         basedir="${classdir}"
         includes="sisc/applet/**"/>
  </target>

  <target name="check" depends="heap" if="junit.present">
    <junit>
      <sysproperty key="HEAP" value="${heap}"/>
      <classpath>
        <pathelement location="${classdir}" />
        <pathelement path="${java.class.path}" />
      </classpath>
      <formatter type="plain"/>
      <test name="sisc.tests.TestR5RS"/>
    </junit>
  </target>
</project>
