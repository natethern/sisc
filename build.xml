<project name="sisc" default="all">

  <path id="classpath">
    <fileset dir="./lib">
      <include name="*.jar"/>
    </fileset>
    <pathelement path=".."/>
  </path>

  <target name="prepare">
    <property file="${basedir}/build.properties"/>    
    <property name="srcdir" value="${basedir}/.."/>
    <property name="classdir" value="${basedir}/classes"/>
    <property name="docdir" value="${basedir}/doc/javadoc"/>
    <property name="schemedir" value="${basedir}/scheme-src"/>
    <property name="packagename" value="sisc"/>
    <property name="jarname" value="sisc.jar"/>
    <property name="heap" value="${basedir}/boot/sisc.heap"/>
    <property name="quantity-type" value="apfloat"/>
  </target>

  <target name="init" depends="prepare">
    <available classname="junit.framework.TestCase"
               property="junit.present"
	       classpathref="classpath"/>
    <available property="oro.present"
	       classname="org.apache.oro.text.regex.Pattern"
	       classpathref="classpath"/>
  </target>

  <target name="docs" depends="init"
          description="Generate Documentation">
    <mkdir dir="${docdir}"/>
    <javadoc packagenames="${packagename}.*"
	     sourcepath="${srcdir}"
	     destdir="${docdir}"/>
  </target>

  <target name="quantity" depends="init">
    <copy file="${basedir}/data/Quantity-${quantity-type}.java"
	  tofile="${basedir}/data/Quantity.java"/>
  </target>

  <target name="compiler" depends="quantity">
    <mkdir dir="${classdir}"/>
    <javac srcdir="${srcdir}"
           destdir="${classdir}"
	   classpathref="classpath"
	   debug="on"
           optimize="on">
      <include name="${packagename}/**"/>
      <exclude name="${packagename}/*/Quantity-*.java"/>
      <exclude name="${packagename}/tests/**" unless="junit.present"/>
      <exclude name="${packagename}/modules/Regexp.java" unless="oro.present"/>
    </javac>      
  </target>
  
  <target name="jars" depends="compiler">
    <jar jarfile="${basedir}/${jarname}"
	 manifest="${basedir}/boot/Manifest"
         basedir="${classdir}"
         includes="*/**"/>
  </target>
  
  <target name="heap" depends="compiler">
    <java classname="sisc.boot.GenerateHeap"
	  classpath="${classdir}"
	  dir="${schemedir}"
	  fork="yes">
      <arg value="-out"/>
      <arg value="${heap}"/>
      <arg value="-files"/>
      <arg value="${schemedir}/init.pp"/>
      <arg value="${schemedir}/compat.pp"/>
      <arg value="${schemedir}/psyntax.pp"/>
      <arg value="${schemedir}/init2.scm"/>
      <arg value="${schemedir}/pp.scm"/>
      <arg value="${schemedir}/repl.scm"/>
    </java>
  </target>

  <target name="all" depends="jars,heap"
          description="Build all">  
  </target>
    
  <target name="clean" depends="init"
          description="Remove generated sources, class files and jar files">
    <delete dir="${classdir}"/>
    <delete dir="${docdir}"/>
    <delete file="${basedir}/${jarname}"/>
    <delete file="${heap}"/>
    <delete file="${basedir}/data/Quantity.java"/>
  </target> 
</project>
